(function() {
  var $$, Achieve, Agent, Assert, Attempt, Context, Message, Module, Propose, Retract, Runner, TS_INIT, TS_RUNNING, Task, _impasse, _start, clone, unit_;

  ({$$, unit_, clone} = require('./common'));

  $$ = unit_(module, $$);

  ({Task, Module, TS_INIT, TS_RUNNING} = require("./task"));

  ({_start, _impasse, Message, Propose, Attempt, Assert, Retract, Achieve} = require("../main"));

  ({Context} = require('../context'));

  Runner = class Runner extends Task {
    constructor(init) {
      super(init);
      this.ctx = new Context();
      this.posts = [];
      this.queue = [];
      this.scheduled = false;
      this.impassed = false;
      this.post(new Attempt(new Achieve(null, _start, null)));
    }

    schedule(t) {
      /*
      if t == this
        if @scheduled then return t
        @scheduled = true
        setImmediate =>
          @scheduled = false
          try
            if @idle() then @impasse() else @action()
          catch err
            @reject err
        return t
      */
      if (t === this) {
        return super.schedule(t);
      }
      if (t instanceof Runner) {
        t.run();
        this.schedule(this);
        return t;
      }
      //Else ...
      t.rnr = this;
      this.queue.push(t);
      this.schedule(this);
      return t;
    }

    broadcast(msg) {
      var i, len, m, ref, results, t;
      m = clone(msg);
      $$.$(`Broadcast:\t${m}`);
      m.from = this;
      this.post(m);
      ref = this.tasks;
      results = [];
      for (i = 0, len = ref.length; i < len; i++) {
        t = ref[i];
        results.push(t.broadcast(m));
      }
      return results;
    }

    post(msg) {
      if (!msg.from) {
        msg.from = this;
      }
      $$.$(`Post:\t${msg}`);
      return this.posts.push(msg);
    }

    fork(t) {
      var child;
      $$.$(`Fork:\t${t.msg}`);
      child = new Runner();
      child.policy = this.policy;
      child.ctx = this.ctx;
      return child.run(t);
    }

    eval(msg) {
      var m, pmsg, ref, results;
      switch (msg.constructor) {
        case Propose:
          $$.$(`* \t${msg}`);
          pmsg = new Attempt();
          Object.assign(pmsg, msg);
          ref = msg.from.matchRules(pmsg);
          results = [];
          for (m of ref) {
            results.push(this.fork(m.to));
          }
          return results;
          break;
        case Assert:
          $$.$(`+ \t${msg}`);
          this.ctx.add(msg.data);
          return this.dispatch(msg);
        case Retract:
          $$.$(`- \t${msg}`);
          this.ctx.remove(msg.data);
          return this.dispatch(msg);
        default:
          $$.$(`Eval:\t${msg}`);
          return this.dispatch(msg);
      }
    }

    dispatch(msg) {
      var m, ref, results;
      ref = msg.from.matchRules(msg);
      results = [];
      for (m of ref) {
        $$.$(`Fire:\t${m}`);
        results.push(this.schedule(m.to));
      }
      return results;
    }

    main() {
      var pStatus, post, status, t;
      $$.$('@main');
      while (t = this.queue.shift()) {
        $$.$('eval tasks');
        $$.$(`Tick:\t(${t.constructor.name}) ${t.msg}`);
        status = t.action();
        if (status === TS_RUNNING) {
          this.queue.push(t);
        } else if (t.parent) {
          pStatus = t.parent.strategy(t);
          if (pStatus === TS_RUNNING) {
            this.queue.push(t.parent);
          }
        } else if (t.caller) {
          t.caller.resume();
          this.queue.push(t.caller);
        }
      }
      while (post = this.posts.shift()) {
        $$.$('eval posts');
        this.eval(post);
      }
      if (this.idle() && this.impasse() && !this.scheduled) {
        this.resolve();
      }
      return this.status;
    }

    idle() {
      return this.posts.length === 0 && this.queue.length === 0 && this.tasks.length === 0;
    }

    impasse() {
      $$.$("@impasse");
      if (this.impassed) {
        return true;
      }
      this.impassed = true;
      this.post(new Attempt(new Achieve(null, _impasse, null)));
      this.schedule(this);
      return false;
    }

    run(...queue) {
      var i, len, task;
      for (i = 0, len = queue.length; i < len; i++) {
        task = queue[i];
        this.schedule(task);
      }
      return this;
    }

  };

  exports.Runner = Runner;

  exports.runner_ = function(before) {
    return new Runner(before);
  };

  
  //Agent

  Agent = class Agent extends Runner {
    constructor() {
      super();
    }

  };

  exports.Agent = Agent;

  exports.agent_ = function(init) {
    return new Agent(init);
  };

}).call(this);

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGFzay9ydW5uZXIuanMiLCJzb3VyY2VzIjpbInRhc2svcnVubmVyLmNvZmZlZSJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTtBQUFBLE1BQUEsRUFBQSxFQUFBLE9BQUEsRUFBQSxLQUFBLEVBQUEsTUFBQSxFQUFBLE9BQUEsRUFBQSxPQUFBLEVBQUEsT0FBQSxFQUFBLE1BQUEsRUFBQSxPQUFBLEVBQUEsT0FBQSxFQUFBLE1BQUEsRUFBQSxPQUFBLEVBQUEsVUFBQSxFQUFBLElBQUEsRUFBQSxRQUFBLEVBQUEsTUFBQSxFQUFBLEtBQUEsRUFBQTs7RUFBQSxDQUFBLENBQUMsRUFBRCxFQUFLLEtBQUwsRUFBWSxLQUFaLENBQUEsR0FBcUIsT0FBQSxDQUFRLFVBQVIsQ0FBckI7O0VBQ0EsRUFBQSxHQUFLLEtBQUEsQ0FBTSxNQUFOLEVBQWMsRUFBZDs7RUFFTCxDQUFBLENBQUMsSUFBRCxFQUFPLE1BQVAsRUFBZSxPQUFmLEVBQXdCLFVBQXhCLENBQUEsR0FBc0MsT0FBQSxDQUFRLFFBQVIsQ0FBdEM7O0VBQ0EsQ0FBQSxDQUFDLE1BQUQsRUFBUyxRQUFULEVBQW1CLE9BQW5CLEVBQTRCLE9BQTVCLEVBQXFDLE9BQXJDLEVBQThDLE1BQTlDLEVBQXNELE9BQXRELEVBQStELE9BQS9ELENBQUEsR0FBMEUsT0FBQSxDQUFRLFNBQVIsQ0FBMUU7O0VBQ0EsQ0FBQSxDQUFDLE9BQUQsQ0FBQSxHQUFZLE9BQUEsQ0FBUSxZQUFSLENBQVo7O0VBRU0sU0FBTixNQUFBLE9BQUEsUUFBcUIsS0FBckI7SUFDRSxXQUFhLENBQUMsSUFBRCxDQUFBO1dBQ1gsQ0FBTSxJQUFOO01BQ0EsSUFBQyxDQUFBLEdBQUQsR0FBTyxJQUFJLE9BQUosQ0FBQTtNQUNQLElBQUMsQ0FBQSxLQUFELEdBQVM7TUFDVCxJQUFDLENBQUEsS0FBRCxHQUFTO01BQ1QsSUFBQyxDQUFBLFNBQUQsR0FBYTtNQUNiLElBQUMsQ0FBQSxRQUFELEdBQVk7TUFDWixJQUFDLENBQUEsSUFBRCxDQUFN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QyxNQUFSLEdBQWlCOztFQUNqQixPQUFPLENBQUMsT0FBUixHQUFrQixRQUFBLENBQUMsTUFBRCxDQUFBO1dBQ2hCLElBQUksTUFBSixDQUFXLE1BQVg7RUFEZ0IsRUFoSWxCOzs7OztFQXNJTSxRQUFOLE1BQUEsTUFBQSxRQUFvQixPQUFwQjtJQUNFLFdBQWEsQ0FBQSxDQUFBO1dBQ1gsQ0FBQTtJQURXOztFQURmOztFQUlBLE9BQU8sQ0FBQyxLQUFSLEdBQWdCOztFQUNoQixPQUFPLENBQUMsTUFBUixHQUFpQixRQUFBLENBQUMsSUFBRCxDQUFBO1dBQ2YsSUFBSSxLQUFKLENBQVUsSUFBVjtFQURlO0FBM0lqQiIsInNvdXJjZXNDb250ZW50IjpbInskJCwgdW5pdF8sIGNsb25lfSA9IHJlcXVpcmUoJy4vY29tbW9uJylcbiQkID0gdW5pdF8gbW9kdWxlLCAkJFxuXG57VGFzaywgTW9kdWxlLCBUU19JTklULCBUU19SVU5OSU5HfSA9IHJlcXVpcmUoXCIuL3Rhc2tcIilcbntfc3RhcnQsIF9pbXBhc3NlLCBNZXNzYWdlLCBQcm9wb3NlLCBBdHRlbXB0LCBBc3NlcnQsIFJldHJhY3QsIEFjaGlldmV9ID0gcmVxdWlyZShcIi4uL21haW5cIilcbntDb250ZXh0fSA9IHJlcXVpcmUgJy4uL2NvbnRleHQnXG5cbmNsYXNzIFJ1bm5lciBleHRlbmRzIFRhc2tcbiAgY29uc3RydWN0b3I6IChpbml0KSAtPlxuICAgIHN1cGVyKGluaXQpXG4gICAgQGN0eCA9IG5ldyBDb250ZXh0KClcbiAgICBAcG9zdHMgPSBbXVxuICAgIEBxdWV1ZSA9IFtdXG4gICAgQHNjaGVkdWxlZCA9IGZhbHNlXG4gICAgQGltcGFzc2VkID0gZmFsc2VcbiAgICBAcG9zdCBuZXcgQXR0ZW1wdChuZXcgQWNoaWV2ZShudWxsLCBfc3RhcnQsIG51bGwpKVxuXG4gIHNjaGVkdWxlOiAodCkgLT5cbiAgICAjIyNcbiAgICBpZiB0ID09IHRoaXNcbiAgICAgIGlmIEBzY2hlZHVsZWQgdGhlbiByZXR1cm4gdFxuICAgICAgQHNjaGVkdWxlZCA9IHRydWVcbiAgICAgIHNldEltbWVkaWF0ZSA9PlxuICAgICAgICBAc2NoZWR1bGVkID0gZmFsc2VcbiAgICAgICAgdHJ5XG4gICAgICAgICAgaWYgQGlkbGUoKSB0aGVuIEBpbXBhc3NlKCkgZWxzZSBAYWN0aW9uKClcbiAgICAgICAgY2F0Y2ggZXJyXG4gICAgICAgICAgQHJlamVjdCBlcnJcbiAgICAgIHJldHVybiB0XG4gICAgIyMjXG4gICAgaWYgdCA9PSB0aGlzIHRoZW4gcmV0dXJuIHN1cGVyIHRcblxuICAgIGlmIHQgaW5zdGFuY2VvZiBSdW5uZXJcbiAgICAgIHQucnVuKClcbiAgICAgIEBzY2hlZHVsZSh0aGlzKVxuICAgICAgcmV0dXJuIHRcbiAgICAjRWxzZSAuLi5cbiAgICB0LnJuciA9IHRoaXNcbiAgICBAcXVldWUucHVzaCh0KVxuICAgIEBzY2hlZHVsZSh0aGlzKVxuICAgIHJldHVybiB0XG5cbiAgYnJvYWRjYXN0OiAobXNnKSAtPlxuICAgIG0gPSBjbG9uZSBtc2dcbiAgICAkJC4kIFwiQnJvYWRjYXN0OlxcdCN7bX1cIlxuICAgIG0uZnJvbSA9IHRoaXNcbiAgICBAcG9zdCBtXG4gICAgZm9yIHQgaW4gQHRhc2tzXG4gICAgICB0LmJyb2FkY2FzdCBtXG5cbiAgcG9zdDogKG1zZykgLT5cbiAgICBpZiAhbXNnLmZyb21cbiAgICAgIG1zZy5mcm9tID0gdGhpc1xuICAgICQkLiQgXCJQb3N0OlxcdCN7bXNnfVwiXG4gICAgQHBvc3RzLnB1c2ggbXNnXG5cbiAgZm9yazogKHQpIC0+XG4gICAgJCQuJChcIkZvcms6XFx0I3t0Lm1zZ31cIilcbiAgICBjaGlsZCA9IG5ldyBSdW5uZXIoKVxuICAgIGNoaWxkLnBvbGljeSA9IEBwb2xpY3lcbiAgICBjaGlsZC5jdHggPSBAY3R4XG4gICAgY2hpbGQucnVuIHRcblxuICBldmFsOiAobXNnKSAtPlxuICAgIHN3aXRjaCBtc2cuY29uc3RydWN0b3JcbiAgICAgIHdoZW4gUHJvcG9zZVxuICAgICAgICAkJC4kKFwiKiBcXHQje21zZ31cIilcbiAgICAgICAgcG1zZyA9IG5ldyBBdHRlbXB0KClcbiAgICAgICAgT2JqZWN0LmFzc2lnbiBwbXNnLCBtc2dcbiAgICAgICAgZm9yIG0gZnJvbSBtc2cuZnJvbS5tYXRjaFJ1bGVzKHBtc2cpXG4gICAgICAgICAgQGZvcmsobS50bylcbiAgICAgIHdoZW4gQXNzZXJ0XG4gICAgICAgICQkLiQoXCIrIFxcdCN7bXNnfVwiKVxuICAgICAgICBAY3R4LmFkZCBtc2cuZGF0YVxuICAgICAgICBAZGlzcGF0Y2ggbXNnXG4gICAgICB3aGVuIFJldHJhY3RcbiAgICAgICAgJCQuJChcIi0gXFx0I3ttc2d9XCIpXG4gICAgICAgIEBjdHgucmVtb3ZlIG1zZy5kYXRhXG4gICAgICAgIEBkaXNwYXRjaCBtc2dcbiAgICAgIGVsc2VcbiAgICAgICAgJCQuJCBcIkV2YWw6XFx0I3ttc2d9XCJcbiAgICAgICAgQGRpc3BhdGNoIG1zZ1xuXG4gIGRpc3BhdGNoOiAobXNnKSAtPlxuICAgIGZvciBtIGZyb20gbXNnLmZyb20ubWF0Y2hSdWxlcyhtc2cpXG4gICAgICAkJC4kKFwiRmlyZTpcXHQje219XCIpXG4gICAgICBAc2NoZWR1bGUobS50bylcblxuICBtYWluOiAtPlxuICAgICQkLiQgJ0BtYWluJ1xuICAgIHdoaWxlIHQgPSBAcXVldWUuc2hpZnQoKVxuICAgICAgJCQuJCAnZXZhbCB0YXNrcydcbiAgICAgICQkLiQgXCJUaWNrOlxcdCgje3QuY29uc3RydWN0b3IubmFtZX0pICN7dC5tc2d9XCJcbiAgICAgIHN0YXR1cyA9IHQuYWN0aW9uKClcbiAgICAgIGlmIHN0YXR1cyA9PSBUU19SVU5OSU5HXG4gICAgICAgIEBxdWV1ZS5wdXNoKHQpXG4gICAgICBlbHNlIGlmIHQucGFyZW50XG4gICAgICAgIHBTdGF0dXMgPSB0LnBhcmVudC5zdHJhdGVneSh0KVxuICAgICAgICBpZiBwU3RhdHVzID09IFRTX1JVTk5JTkdcbiAgICAgICAgICBAcXVldWUucHVzaCh0LnBhcmVudClcbiAgICAgIGVsc2UgaWYgdC5jYWxsZXJcbiAgICAgICAgdC5jYWxsZXIucmVzdW1lKClcbiAgICAgICAgQHF1ZXVlLnB1c2godC5jYWxsZXIpXG5cbiAgICB3aGlsZSBwb3N0ID0gQHBvc3RzLnNoaWZ0KClcbiAgICAgICQkLiQgJ2V2YWwgcG9zdHMnXG4gICAgICBAZXZhbCBwb3N0XG5cbiAgICBpZiBAaWRsZSgpICYmIEBpbXBhc3NlKCkgJiYgIUBzY2hlZHVsZWQgdGhlbiBAcmVzb2x2ZSgpXG4gICAgcmV0dXJuIEBzdGF0dXNcblxuICBpZGxlOiAtPlxuICAgIEBwb3N0cy5sZW5ndGggPT0gMCAmJiBAcXVldWUubGVuZ3RoID09IDAgJiYgQHRhc2tzLmxlbmd0aCA9PSAwXG5cbiAgaW1wYXNzZTogLT5cbiAgICAkJC4kIFwiQGltcGFzc2VcIlxuICAgIGlmIEBpbXBhc3NlZCB0aGVuIHJldHVybiB0cnVlXG4gICAgQGltcGFzc2VkID0gdHJ1ZVxuICAgIEBwb3N0IG5ldyBBdHRlbXB0KG5ldyBBY2hpZXZlKG51bGwsIF9pbXBhc3NlLCBudWxsKSlcbiAgICBAc2NoZWR1bGUgdGhpc1xuICAgIHJldHVybiBmYWxzZVxuXG4gIHJ1bjogKHF1ZXVlLi4uKSAtPlxuICAgIGZvciB0YXNrIGluIHF1ZXVlXG4gICAgICBAc2NoZWR1bGUodGFzaylcbiAgICByZXR1cm4gdGhpc1xuXG5leHBvcnRzLlJ1bm5lciA9IFJ1bm5lclxuZXhwb3J0cy5ydW5uZXJfID0gKGJlZm9yZSkgLT5cbiAgbmV3IFJ1bm5lciBiZWZvcmVcblxuI1xuI0FnZW50XG4jXG5jbGFzcyBBZ2VudCBleHRlbmRzIFJ1bm5lclxuICBjb25zdHJ1Y3RvcjogLT5cbiAgICBzdXBlcigpXG5cbmV4cG9ydHMuQWdlbnQgPSBBZ2VudFxuZXhwb3J0cy5hZ2VudF8gPSAoaW5pdCkgLT5cbiAgbmV3IEFnZW50IGluaXRcbiJdfQ==
